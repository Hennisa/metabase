databaseChangeLog:
  - changeSet:
      id: 40
      author: camsaul
      changes:
        ############################################################ add PermissionsGruop table ############################################################
        - createTable:
            tableName: permissions_group
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              # TODO - can we make this a case-insensitive unique constraint / index?
              - column:
                  name: name
                  type: varchar(256)
                  constraints:
                    nullable: false
                    unique: true
                    uniqueConstraintName: unique_permissions_group_name
        - createIndex:
            tableName: permissions_group
            indexName: idx_permissions_group_name
            columns:
              column:
                name: name
        ############################################################ add PermissionsGroupMembership table ############################################################
        - createTable:
            tableName: permissions_group_membership
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: user_id
                  type: int
                  constraints:
                    nullable: false
                    references: core_user(id)
                    foreignKeyName: fk_permissions_group_membership_user_id
              - column:
                  name: group_id
                  type: int
                  constraints:
                    nullable: false
                    references: permissions_group(id)
                    foreignKeyName: fk_permissions_group_group_id
        - addUniqueConstraint:
            tableName: permissions_group_membership
            columnNames: user_id, group_id
            constraintName: unique_permissions_group_membership_user_id_group_id
        # for things like all users in a given group
        - createIndex:
            tableName: permissions_group_membership
            indexName: idx_permissions_group_membership_group_id
            columns:
              column:
                name: group_id
        # for things like all groups a user belongs to
        - createIndex:
            tableName: permissions_group_membership
            indexName: idx_permissions_group_membership_user_id
            columns:
              column:
                name: user_id
        # TODO - do we need an index for group_id + user_id ? (for this like is user part of group)
        ############################################################ add DatabasePermissions table ############################################################
        - createTable:
            tableName: database_permissions
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: group_id
                  # TODO
              - column:
                  name: database_id
                  # TODO
              # TODO - better name?
              - column:
                  name: unrestricted_schema_access
                  # TODO
              - column:
                  name: native_query_access
                  # TODO
        # TODO - unique constraint for group_id + database_id
        # TODO - index for group_id (for things like which databases does this group have access to)
        # TODO - index for database_id (for things like which groups have access for given DB)
        # TODO - index for group_id + database_id (for things like does this group have access to this DB -- do we need this?)
        ############################################################ add SchemaPermissions table ############################################################
        - createTable:
            tableName: schema_permissions
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: group_id
                  type: int
                  constraints:
                    nullable: false
                    references: permissions_group(id)
              - column:
                  name: database_id
                  type: int
                  constraints:
                    nullable: false
                    references: metabase_database(id)
              - column:
                  name: schema
                  type: varchar(256)
                  constraints:
                    nullable: false
                    references: metabase_table(schema)
        - addUniqueConstraint:
            tableName: schema_permissions
            columnNames: group_id, database_id, schema
        # TODO - indexes as appropriate
        ############################################################ add TablePermissions table ############################################################
        - createTable:
            tableName: table_permissions
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: group_id
                  type: int
                  constraints:
                    nullable: false
                    references: permissions_group(id)
              - column:
                  name: table_id
                  type: int
                  constraints:
                    nullable: false
                    references: metabase_table(id)
        - addUniqueConstraint:
            tableName: table_permissions
            columnNames: group_id, table_id
        # TODO - index for group_id (to see which tables a group has permissions for)
        # TODO - index for table_id (to see groups have permissions for a table (?))
        # TODO - index for group_id + table_id (to see if a given group has permissions for a given table)
        ############################################################ Add indexes for table db_id + schema ############################################################
        # This is for doing things like getting all the tables that belong to a given schema
        - createIndex:
            tableName: metabase_table
            indexName: idx_metabase_table_db_id_schema
            columns:
              column:
                name: db_id
              column:
                name: schema
